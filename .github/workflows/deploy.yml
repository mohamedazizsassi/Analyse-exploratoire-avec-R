name: Deploy Quarto Website

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Setup Quarto
      uses: quarto-dev/quarto-actions/setup@v2
    
    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.2'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/quarto
          ~/.local/share/quarto
          ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-cache-${{ hashFiles('**/_quarto.yml', '**/*.qmd') }}
        restore-keys: |
          ${{ runner.os }}-cache-
    
    # SECTION CORRIGÃ‰E :
    - name: Verify WebR extensions
      run: |
        echo "ğŸ” VÃ©rification des extensions WebR..."
        
        # VÃ©rifier les extensions dÃ©jÃ  prÃ©sentes
        if [ -d "_extensions" ]; then
          echo "ğŸ“ Extensions trouvÃ©es:"
          ls -la _extensions/
        else
          echo "ğŸ“ Dossier _extensions/ non trouvÃ©"
        fi
        
        # Installer WebR seulement si absent
        if [ ! -d "_extensions/coatless" ]; then
          echo "ğŸ“¦ Installation de l'extension WebR..."
          quarto add coatless/webr --no-prompt
        else
          echo "âœ… Extension WebR (coatless) dÃ©jÃ  installÃ©e"
        fi
        
        if [ ! -d "_extensions/r-wasm" ]; then
          echo "ğŸ“¦ Installation de l'extension r-wasm..."
          quarto add r-wasm/webr-web --no-prompt
        else
          echo "âœ… Extension r-wasm dÃ©jÃ  installÃ©e"
        fi
    
    - name: Install system dependencies
      run: |
        echo "ğŸ“¥ Installation des dÃ©pendances systÃ¨me..."
        sudo apt-get update
        sudo apt-get install -y \
          libcurl4-openssl-dev \
          libssl-dev \
          libxml2-dev \
          libfontconfig1-dev \
          libharfbuzz-dev \
          libfribidi-dev \
          libfreetype6-dev \
          libpng-dev \
          libtiff5-dev \
          libjpeg-dev \
          libicu-dev
    
    - name: Install R packages
      run: |
        echo "ğŸ“¦ Installation des packages R..."
        
        # Packages minimaux pour WebR
        Rscript -e "install.packages(c('dplyr', 'ggplot2', 'readxl'), repos = 'https://cloud.r-project.org')"
        
        # VÃ©rifier l'installation
        Rscript -e "cat('âœ… Packages R installÃ©s\n')"
        Rscript -e "print(sessionInfo())"
    
    - name: Render Quarto website
      run: |
        echo "ğŸš€ DÃ©marrage du rendu Quarto..."
        
        # Nettoyer le dossier docs
        if [ -d "docs" ]; then
          echo "ğŸ§¹ Nettoyage du dossier docs existant..."
          rm -rf docs
        fi
        
        # VÃ©rifier la configuration
        echo "âš™ï¸ VÃ©rification Quarto:"
        quarto check || true
        
        # Rendre le site
        echo "ğŸ“„ Rendu du site..."
        quarto render
        
        # DEBUG: Voir ce qui a Ã©tÃ© gÃ©nÃ©rÃ©
        echo "ğŸ“ CONTENU de docs/:"
        ls -la docs/
        echo ""
        echo "ğŸ“„ Fichiers HTML gÃ©nÃ©rÃ©s:"
        find docs -name "*.html" -type f | sort
        
        # RENOMMER index.qmd.html si nÃ©cessaire
        echo ""
        echo "ğŸ”„ VÃ©rification du fichier index..."
        if [ -f "docs/index.qmd.html" ]; then
          echo "ğŸ“ Renommage: index.qmd.html â†’ index.html"
          mv docs/index.qmd.html docs/index.html
          echo "âœ… index.html crÃ©Ã©"
        elif [ -f "docs/index.html" ]; then
          echo "âœ… index.html existe dÃ©jÃ "
        else
          echo "âš ï¸ Aucun index trouvÃ©, crÃ©ation..."
          # Chercher le premier fichier HTML
          first_html=$(find docs -name "*.html" -type f | head -1)
          if [ -n "$first_html" ]; then
            echo "ğŸ“ CrÃ©ation d'un index avec redirection vers: $first_html"
            echo "<!DOCTYPE html>
            <html>
            <head>
              <title>Data Analysis Lab</title>
              <meta http-equiv=\"refresh\" content=\"0; url=$(basename $first_html)\">
            </head>
            <body>
              <p>Redirecting... <a href=\"$(basename $first_html)\">Click here</a></p>
            </body>
            </html>" > docs/index.html
          else
            echo "âŒ Aucun fichier HTML gÃ©nÃ©rÃ©!"
            exit 1
          fi
        fi
        
        # VÃ©rification finale
        echo "ğŸ” VÃ©rification finale:"
        echo "index.html: $(if [ -f "docs/index.html" ]; then echo 'âœ… PrÃ©sent'; else echo 'âŒ Absent'; fi)"
    
    - name: Prepare for GitHub Pages
      run: |
        echo "ğŸ”§ PrÃ©paration pour GitHub Pages..."
        
        # Fichiers obligatoires
        touch docs/.nojekyll
        echo "âœ… .nojekyll crÃ©Ã©"
        
        # VÃ©rification
        echo "ğŸ“‹ Contenu final de docs/:"
        ls -la docs/
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v3