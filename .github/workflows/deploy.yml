name: Deploy Quarto Website

on:
  push:
    branches: [main]

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-packages-${{ hashFiles('**/*.qmd', '**/_quarto.yml') }}
          restore-keys: |
            ${{ runner.os }}-r-packages-

      - name: Install REQUIRED R packages
        run: |
          echo "üì¶ Installation des packages R ESSENTIELS..."
          
          # Mettre √† jour les repos
          Rscript -e "options(repos = c(CRAN = 'https://cloud.r-project.org'))"
          
          # Packages CRITIQUES pour Quarto/R Markdown
          Rscript -e "install.packages(c('rmarkdown', 'knitr'), dependencies = TRUE)"
          
          # Packages pour vos analyses
          Rscript -e "install.packages(c('dplyr', 'ggplot2', 'readxl', 'tidyr', 'lubridate'), dependencies = TRUE)"
          
          # V√©rification
          Rscript -e "
            cat('‚úÖ Packages install√©s:\n')
            cat('- rmarkdown:', packageVersion('rmarkdown'), '\n')
            cat('- knitr:', packageVersion('knitr'), '\n')
            cat('- dplyr:', if(requireNamespace('dplyr', quietly=TRUE)) packageVersion('dplyr') else 'NON', '\n')
          "

      - name: Verify WebR extensions
        run: |
          echo "üîç V√©rification des extensions..."
          if [ ! -d "_extensions/coatless" ]; then
            echo "üì¶ Installation de WebR extension..."
            quarto add coatless/webr --no-prompt
          else
            echo "‚úÖ Extension WebR pr√©sente"
          fi

      - name: Install system dependencies
        run: |
          echo "üì• Installation des d√©pendances syst√®me..."
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev

      - name: Render Quarto website (HTML ONLY)
        run: |
          echo "üöÄ Rendu du site Quarto..."
          
          # Nettoyer
          rm -rf docs/
          
          # RENDRE EN HTML SEULEMENT
          quarto render --to html
          
          # DEBUG: Voir ce qui a √©t√© g√©n√©r√©
          echo "üìÅ Contenu de docs/:"
          ls -la docs/
          
          # G√©rer le fichier index
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "‚úÖ index.qmd.html ‚Üí index.html"
          elif [ ! -f "docs/index.html" ]; then
            echo "‚ö†Ô∏è Cr√©ation d'index.html minimal"
            echo '<!DOCTYPE html>
            <html>
            <head>
              <title>Data Analysis Lab</title>
              <meta http-equiv="refresh" content="0; url=qmd/">
            </head>
            <body>
              <p>Redirecting to exercises...</p>
            </body>
            </html>' > docs/index.html
          fi
          
          # Fichier OBLIGATOIRE pour GitHub Pages
          touch docs/.nojekyll
          
          echo "‚úÖ Rendu termin√© avec succ√®s"

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v3