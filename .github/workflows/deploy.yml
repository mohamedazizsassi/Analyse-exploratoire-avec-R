name: Deploy Quarto Website - NO JEKYLL

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      JEKYLL_ENV: "disabled"
      DISABLE_JEKYLL: "true"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove docs directory completely
        run: |
          echo "üóëÔ∏è  SUPPRESSION COMPL√àTE du dossier docs..."
          rm -rf docs/ _site/ 2>/dev/null || true
          echo "‚úÖ Nettoy√©"

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel jupyter-cache

      - name: Setup R for binary packages
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'

      # √âTAPE CRITIQUE : Installation R depuis BINAIRES SEULEMENT
      - name: Install R packages FROM BINARIES (NO SOURCE COMPILATION)
        run: |
          echo "‚ö°‚ö°‚ö° INSTALLATION R - BINAIRES UNIQUEMENT ‚ö°‚ö°‚ö°"
          echo "‚ö†Ô∏è  COMPILATION SOURCE : D√âSACTIV√âE"
          
          # Configuration AGGRESSIVE pour binaires
          cat > ~/.Rprofile << 'EOF'
          # =================================================
          # CONFIGURATION ULTRA-OPTIMIS√âE POUR BINAIRES
          # =================================================
          
          # 1. D√âSACTIVER TOUTE COMPILATION
          options(
            # NE JAMAIS compiler depuis les sources
            install.packages.compile.from.source = "never",
            # Ne pas v√©rifier les sources
            install.packages.check.source = "no",
            # Installation parall√®le maximale
            Ncpus = 6,
            # Timeout long pour gros packages
            timeout = 300,
            # Options d'installation POUR BINAIRES
            INSTALL_opts = c(
              "--no-multiarch",
              "--no-docs", 
              "--no-test-load",
              "--no-byte-compile",
              "--no-staged-install",
              "--no-data"
            )
          )
          
          # 2. UTILISER RSPM POUR BINAIRES UBUNTU 22.04
          # RStudio Package Manager - binaires pr√©-compil√©s
          ubuntu_codename <- "jammy"  # Ubuntu 22.04
          rspm_url <- paste0(
            "https://packagemanager.rstudio.com/cran/__linux__/",
            ubuntu_codename,
            "/latest"
          )
          
          # D√©finir comme d√©p√¥t PRINCIPAL
          options(repos = c(RSPM = rspm_url))
          
          cat("\n")
          cat("=========================================\n")
          cat("üéØ MODE BINAIRE FORC√â ACTIV√â\n")
          cat("üîß D√©p√¥t :", rspm_url, "\n")
          cat("üö´ Compilation source : INTERDITE\n")
          cat("‚ö° Ncpus :", getOption("Ncpus"), "\n")
          cat("=========================================\n")
          EOF
          
          # V√âRIFIER LA CONFIGURATION
          echo "üîç V√©rification configuration R..."
          Rscript -e "
          cat('\n=== CONFIGURATION ACTIVE ===\n')
          cat('1. D√©p√¥t      :', getOption('repos')[1], '\n')
          cat('2. Compilation:', getOption('install.packages.compile.from.source'), '\n')
          cat('3. Ncpus      :', getOption('Ncpus'), '\n')
          cat('4. INSTALL_opts:', paste(getOption('INSTALL_opts'), collapse=', '), '\n')
          cat('=============================\n')
          "
          
          # LISTE DES PACKAGES (optimis√©e pour vitesse)
          Rscript -e "
          start_time <- Sys.time()
          cat('üì¶ D√©but de l\'installation des packages R...\n\n')
          
          # Packages par groupe (installation plus stable)
          groups <- list(
            'Groupe 1 - Core' = c('rmarkdown', 'knitr'),
            'Groupe 2 - Tidyverse' = c('dplyr', 'ggplot2', 'tidyr'),
            'Groupe 3 - Data I/O' = c('readxl', 'lubridate'),
            'Groupe 4 - Stats' = c('car', 'lmtest', 'gplots')
          )
          
          # Fonction d'installation avec retry
          install_group <- function(pkgs, group_name, max_retries = 2) {
            cat('\n---', group_name, '---\n')
            
            for (retry in 1:max_retries) {
              tryCatch({
                cat('Tentative', retry, ': ', paste(pkgs, collapse=', '), '\n')
                
                # Essayer d'abord avec type='binary'
                result <- tryCatch({
                  install.packages(pkgs, type = 'binary', quiet = TRUE)
                  '‚úÖ Binaire'
                }, error = function(e1) {
                  # Fallback sans type='binary' mais avec options anti-compilation
                  install.packages(pkgs, quiet = TRUE)
                  '‚ö†Ô∏è  Standard (fallback)'
                })
                
                cat('Succ√®s :', result, '\n')
                return(TRUE)
                
              }, error = function(e) {
                if (retry == max_retries) {
                  cat('‚ùå √âchec apr√®s', max_retries, 'tentatives\n')
                  cat('Erreur :', e$message, '\n')
                  return(FALSE)
                }
                cat('‚è±Ô∏è  Pause de 5 secondes avant r√©essai...\n')
                Sys.sleep(5)
              })
            }
          }
          
          # Installer chaque groupe
          for (group_name in names(groups)) {
            install_group(groups[[group_name]], group_name)
          }
          
          # V√âRIFICATION FINALE
          cat('\n=== V√âRIFICATION DES INSTALLATIONS ===\n')
          all_pkgs <- unlist(groups, use.names = FALSE)
          installed <- rownames(installed.packages())
          
          success_count <- 0
          for (pkg in all_pkgs) {
            if (pkg %in% installed) {
              version <- packageVersion(pkg)
              cat('‚úì', pkg, 'v', as.character(version), '\n')
              success_count <- success_count + 1
            } else {
              cat('‚úó', pkg, 'MANQUANT\n')
            }
          }
          
          end_time <- Sys.time()
          total_time <- round(difftime(end_time, start_time, units = 'secs'), 1)
          
          cat('\nüìä R√âSUM√â :\n')
          cat('  Packages :', success_count, '/', length(all_pkgs), '\n')
          cat('  Temps    :', total_time, 'secondes\n')
          
          if (success_count == length(all_pkgs)) {
            cat('üéØ SUCC√àS COMPLET\n')
          } else {
            cat('‚ö†Ô∏è  ATTENTION : Certains packages manquent\n')
          }
          "
          
          echo "‚úÖ Installation R termin√©e"

      - name: Render Quarto website
        run: |
          echo "üöÄ Rendu du site Quarto..."
          
          # Rendre avec cache d√©sactiv√© (plus fiable)
          quarto render --no-cache
          
          echo "‚úÖ Rendu termin√©"

      # √âTAPE CRITIQUE : Post-traitement SANS JEKYL
      - name: Post-process to ELIMINATE Jekyll
        run: |
          echo "üõë √âLIMINATION D√âFINITIVE DE JEKYLL..."
          
          # S'assurer que docs/ existe
          if [ ! -d "docs" ]; then
            echo "‚ùå ERREUR : docs/ non trouv√© apr√®s rendu"
            exit 1
          fi
          
          # 1. CR√âER .nojekyll EXPLICITE
          echo "# ===========================================" > docs/.nojekyll
          echo "# JEKYLL COMPLETELY DISABLED" >> docs/.nojekyll
          echo "# This is a static HTML site" >> docs/.nojekyll
          echo "# GitHub Pages: DO NOT PROCESS WITH JEKYLL" >> docs/.nojekyll
          echo "# Generated by Quarto on $(date)" >> docs/.nojekyll
          echo "# ===========================================" >> docs/.nojekyll
          
          # 2. SUPPRIMER TOUS LES FICHIERS .scss/.sass
          echo "üî™ Suppression des fichiers SCSS/SASS..."
          scss_files=$(find docs -name "*.scss" -o -name "*.sass" 2>/dev/null | wc -l)
          echo "Fichiers trouv√©s: $scss_files"
          
          if [ "$scss_files" -gt 0 ]; then
            find docs -name "*.scss" -type f -delete
            find docs -name "*.sass" -type f -delete
            echo "‚úÖ Fichiers supprim√©s"
          fi
          
          # 3. Renommer index
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "‚úÖ index.qmd.html ‚Üí index.html"
          fi
          
          # 4. V√âRIFICATION FINALE
          echo "üîç V√âRIFICATION FINALE :"
          echo "  - .nojekyll pr√©sent: $(test -f docs/.nojekyll && echo 'OUI' || echo 'NON')"
          echo "  - Fichiers .scss restants: $(find docs -name '*.scss' 2>/dev/null | wc -l)"
          echo "  - Fichiers .sass restants: $(find docs -name '*.sass' 2>/dev/null | wc -l)"
          
          # Lister les premiers fichiers
          echo "üìÅ Premier fichiers dans docs/:"
          ls -la docs/ | head -5

      - name: Deploy to GitHub Pages (custom branch)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages-quarto  # Branche custom pour √©viter conflits
          force_orphan: true
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'