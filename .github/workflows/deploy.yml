name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # AJOUTER CETTE VARIABLE D'ENVIRONNEMENT
    env:
      JEKYLL_ENV: production  # D√©sactive certaines fonctionnalit√©s Jekyll
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel jupyter-cache nbclient

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          use-public-rspm: true

      - name: Install R packages
        run: |
          Rscript -e "
          options(Ncpus = 4, install.packages.compile.from.source = 'never')
          install.packages(
            c('rmarkdown', 'knitr', 'dplyr', 'ggplot2', 'tidyr', 
              'readxl', 'lubridate', 'car', 'lmtest', 'gplots'),
            repos = 'https://cran.rstudio.com/',
            quiet = FALSE
          )
          "

      # √âTAPE CRITIQUE : D√©sactiver Jekyll AVANT le rendu
      - name: Pre-disable Jekyll
        run: |
          echo "üõë D√âSACTIVATION DE JEKYLL (avant rendu)..."
          
          # Cr√©er .nojekyll √† la racine du projet
          touch .nojekyll
          
          # Cr√©er aussi dans le futur dossier docs
          mkdir -p docs
          touch docs/.nojekyll
          
          # Supprimer tout fichier qui pourrait d√©clencher Jekyll
          rm -rf docs/_site docs/_config.yml docs/Gemfile 2>/dev/null || true
          
          echo "‚úÖ Jekyll pr√©-d√©sactiv√©"

      - name: Clean before render
        run: |
          echo "üßπ Nettoyage avant rendu..."
          # Garder .nojekyll mais nettoyer le reste
          find . -name "_site" -type d -exec rm -rf {} + 2>/dev/null || true
          rm -rf _freeze/ .quarto-cache/ 2>/dev/null || true

      - name: Render website with explicit Jekyll disable
        run: |
          echo "üöÄ Rendu du site web (Jekyll d√©sactiv√©)..."
          
          # Forcer Quarto √† ignorer Jekyll
          export JEKYLL_ENV=production
          
          # Rendu avec option --no-jekyll si disponible
          quarto render || quarto render --cache
          
          echo "‚úÖ Rendu termin√©"

      # √âTAPE CRITIQUE : Post-d√©sactivation de Jekyll
      - name: Post-disable Jekyll (force)
        run: |
          echo "üõë D√âSACTIVATION FORC√âE DE JEKYLL (apr√®s rendu)..."
          
          # S'assurer que docs/ existe
          mkdir -p docs
          
          # 1. .nojekyll dans docs/ (le plus important)
          echo "NO JEKYLL - Static site" > docs/.nojekyll
          
          # 2. Cr√©er un fichier .no-jekyll aussi (pour certains syst√®mes)
          echo "" > docs/.no-jekyll 2>/dev/null || true
          
          # 3. Supprimer TOUS les fichiers/dossiers Jekyll
          echo "Suppression des fichiers Jekyll..."
          find docs/ -name "_*" -type d -exec rm -rf {} + 2>/dev/null || true
          find docs/ -name "*.scss" -type f -delete 2>/dev/null || true
          find docs/ -name "*.sass" -type f -delete 2>/dev/null || true
          find docs/ -name "_config*" -type f -delete 2>/dev/null || true
          find docs/ -name "Gemfile*" -type f -delete 2>/dev/null || true
          
          # 4. Renommer index.qmd.html si n√©cessaire
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "‚úÖ index.qmd.html ‚Üí index.html"
          fi
          
          # 5. V√©rifier qu'il n'y a pas de assets/css/style.scss
          if [ -f "docs/assets/css/style.scss" ]; then
            echo "‚ö†Ô∏è  Suppression de style.scss probl√©matique"
            rm -f docs/assets/css/style.scss
            # Cr√©er un fichier CSS vide √† la place
            mkdir -p docs/assets/css
            echo "/* CSS vide - Jekyll d√©sactiv√© */" > docs/assets/css/style.css
          fi
          
          # 6. Liste finale pour v√©rification
          echo "üìÅ Contenu final de docs/:"
          ls -la docs/
          echo ""
          echo "üîç Fichiers cach√©s:"
          ls -la docs/.* 2>/dev/null || true
          
          echo "‚úÖ Jekyll compl√®tement d√©sactiv√©"

      - name: Verify no Jekyll files remain
        run: |
          echo "üîç V√©rification qu'aucun fichier Jekyll ne reste..."
          
          if find docs/ -name "*.scss" -o -name "_*" -type d | grep -q .; then
            echo "‚ùå Fichiers Jekyll d√©tect√©s!"
            find docs/ -name "*.scss" -o -name "_*" -type d
            exit 1
          else
            echo "‚úÖ Aucun fichier Jekyll d√©tect√©"
          fi
          
          # V√©rifier que .nojekyll existe
          if [ -f "docs/.nojekyll" ]; then
            echo "‚úÖ .nojekyll pr√©sent"
          else
            echo "‚ùå .nojekyll manquant!"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3