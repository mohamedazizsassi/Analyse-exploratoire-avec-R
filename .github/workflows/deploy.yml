name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

# AJOUTER 'contents: read' et configurer correctement
permissions:
  contents: read  # <-- AJOUTER CETTE LIGNE
  pages: write
  id-token: write

# AJOUTER la configuration de concurrence
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter with cache
        run: |
          echo "ðŸ Installation Python/Jupyter..."
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel jupyter-cache nbclient
          echo "âœ… jupyter-cache installÃ©"

      - name: Setup R with binary repository
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          # Ceci configure automatiquement RSPM pour les binaires
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v3
        id: r-cache
        with:
          path: |
            /usr/local/lib/R/site-library
            ~/.R/library
          key: ${{ runner.os }}-r4.3-packages-${{ hashFiles('.github/workflows/deploy.yml') }}
          restore-keys: |
            ${{ runner.os }}-r4.3-packages-

      - name: Install system dependencies
        run: |
          echo "ðŸ“¦ DÃ©pendances systÃ¨me..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libharfbuzz-dev \
            libfribidi-dev

      - name: Install R packages FAST (with RSPM binaries)
        if: steps.r-cache.outputs.cache-hit != 'true'
        run: |
          echo "âš¡ Installation ULTRA RAPIDE des packages R via RSPM..."
          
          # Configuration R pour RSPM (binaires Ubuntu 22.04)
          cat > ~/.Rprofile << 'EOF'
          # Configuration GitHub Actions - RSPM pour binaires
          local({
            # DÃ©tecter si nous sommes sur Ubuntu
            os <- Sys.info()[["sysname"]]
            if (os == "Linux") {
              # Utiliser RSPM avec binaires prÃ©-compilÃ©s
              options(repos = c(
                RSPM = "https://packagemanager.rstudio.com/cran/__linux__/jammy/latest",
                CRAN = "https://cloud.r-project.org"
              ))
              # DÃ©sactiver la compilation depuis source
              options(install.packages.compile.from.source = "never")
            } else {
              options(repos = c(CRAN = "https://cloud.r-project.org"))
            }
            # Installation parallÃ¨le
            options(Ncpus = 4)
            # Options d'installation
            options(INSTALL_opts = "--no-multiarch --no-docs --no-test-load")
          })
          EOF
          
          # VÃ©rifier la configuration
          echo "ðŸ” Configuration des dÃ©pÃ´ts R :"
          Rscript -e "getOption('repos')"
          
          # Installation optimisÃ©e
          Rscript -e "
          start_time <- Sys.time()
          
          # Tous les packages en une seule commande (plus efficace)
          all_pkgs <- c(
            # Core Quarto/Rmarkdown
            'rmarkdown', 'knitr', 'tinytex',
            # Tidyverse (essentiels)
            'dplyr', 'ggplot2', 'tidyr', 'readxl', 'lubridate',
            # Stats
            'car', 'lmtest', 'gplots',
            # Utilitaires
            'stringr', 'purrr', 'tibble', 'rlang'
          )
          
          cat('ðŸ“¦ Installation de', length(all_pkgs), 'packages...\\n')
          
          # Installer avec retry en cas d'Ã©chec
          install_with_retry <- function(pkgs, retries = 2) {
            for (i in 1:retries) {
              tryCatch({
                install.packages(pkgs, quiet = TRUE, Ncpus = 4)
                cat('âœ… Installation rÃ©ussie (tentative', i, ')\\n')
                return(TRUE)
              }, error = function(e) {
                if (i == retries) {
                  cat('âŒ Ã‰chec aprÃ¨s', retries, 'tentatives:\\n', e$message, '\\n')
                  return(FALSE)
                }
                cat('âš ï¸ Tentative', i, 'Ã©chouÃ©e, rÃ©essaye...\\n')
                Sys.sleep(3)
              })
            }
          }
          
          # Installer par groupes (plus stable)
          install_with_retry(c('rmarkdown', 'knitr'))
          install_with_retry(c('dplyr', 'ggplot2', 'tidyr'))
          install_with_retry(c('readxl', 'lubridate', 'stringr', 'purrr'))
          install_with_retry(c('car', 'lmtest', 'gplots'))
          
          # VÃ©rification finale
          cat('\\nâœ… VÃ©rification des installations...\\n')
          installed <- rownames(installed.packages())
          
          for (pkg in all_pkgs) {
            if (pkg %in% installed) {
              cat('âœ“', pkg, '\\n')
            } else {
              cat('âœ—', pkg, '(MANQUANT)\\n')
              # Tentative individuelle pour les packages manquants
              tryCatch({
                install.packages(pkg, quiet = TRUE)
                cat('  â†’ RÃ©installÃ©\\n')
              }, error = function(e) NULL)
            }
          }
          
          end_time <- Sys.time()
          cat('\\nâ±ï¸ Temps total:', round(difftime(end_time, start_time, units = 'mins'), 1), 'minutes\\n')
          "
          
          echo "ðŸŽ¯ Packages R installÃ©s avec succÃ¨s!"

      - name: Install TinyTeX (for PDF if needed)
        run: |
          echo "ðŸ“„ Installation de TinyTeX..."
          Rscript -e "
          if(!requireNamespace('tinytex', quietly = TRUE)) {
            install.packages('tinytex')
          }
          tinytex::install_tinytex()
          "

      - name: Clean temporary files
        run: |
          echo "ðŸ§¹ Nettoyage..."
          rm -rf _freeze/ .quarto-cache/ 2>/dev/null || true

      - name: Render website
        run: |
          echo "ðŸš€ Rendu du site web..."
          
          # Option avec cache
          quarto render --cache
          
          # Post-traitement
          [ -f "docs/index.qmd.html" ] && mv docs/index.qmd.html docs/index.html
          touch docs/.nojekyll
          
          echo "âœ… GÃ©nÃ©ration terminÃ©e!"

      - name: Setup Pages  # <-- AJOUTER CETTE Ã‰TAPE
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3