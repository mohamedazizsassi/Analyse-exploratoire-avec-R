name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup Python and Jupyter
        run: |
          echo "üêç Installation de Python et Jupyter..."
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel
          
          # V√©rifier l'installation
          python3 -m pip list | grep -E "(jupyter|nbformat|ipykernel)"
          python3 -m jupyter --version

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install R packages
        run: |
          echo "üì¶ Installation des packages R..."
          Rscript -e "
            pkgs <- c('rmarkdown', 'knitr', 'dplyr', 'ggplot2', 'readxl', 
                     'tidyr', 'lubridate', 'car', 'lmtest', 'gplots')
            install.packages(pkgs, repos = 'https://cloud.r-project.org')
          "

      - name: Install system dependencies
        run: |
          echo "üì• D√©pendances syst√®me..."
          sudo apt-get update -q
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev

      - name: Render website
        run: |
          echo "üöÄ Rendu du site web..."
          rm -rf docs/
          
          # Rendu normal - Quarto utilisera Jupyter si n√©cessaire
          quarto render
          
          # G√©rer la page d'accueil
          [ -f "docs/index.qmd.html" ] && mv docs/index.qmd.html docs/index.html
          [ ! -f "docs/index.html" ] && echo '<html><meta http-equiv="refresh" content="0;url=qmd/"></html>' > docs/index.html
          
          # GitHub Pages
          touch docs/.nojekyll
          
          echo "‚úÖ Site g√©n√©r√©"
          echo "üìÅ Contenu :"
          ls -la docs/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3