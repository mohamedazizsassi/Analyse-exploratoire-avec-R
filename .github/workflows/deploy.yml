name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'

      - name: Install R packages from binaries
        run: |
          echo "‚ö° Installation R depuis binaires..."
          
          # FORCER l'installation depuis binaires
          Rscript -e "
          options(
            install.packages.compile.from.source = 'never',
            Ncpus = 4,
            repos = 'https://cloud.r-project.org'
          )
          
          packages <- c('rmarkdown', 'knitr', 'dplyr', 'ggplot2', 
                       'tidyr', 'readxl', 'lubridate', 'car', 'lmtest')
          
          # Installer en une fois
          install.packages(packages, quiet = FALSE)
          "

      # √âTAPE CRITIQUE : NETTOYAGE COMPLET avant rendu
      - name: Clean everything before render
        run: |
          echo "üßπ NETTOYAGE COMPLET..."
          
          # Supprimer TOUT ce qui pourrait d√©clencher Jekyll
          rm -rf docs/ _site/ _freeze/ .quarto-cache/ 2>/dev/null || true
          
          # Supprimer tous les fichiers SCSS/SASS dans tout le projet
          find . -name "*.scss" -type f -delete 2>/dev/null || true
          find . -name "*.sass" -type f -delete 2>/dev/null || true
          find . -name "_config*" -type f -delete 2>/dev/null || true
          find . -name "Gemfile*" -type f -delete 2>/dev/null || true
          
          echo "‚úÖ Nettoyage termin√©"

      # √âTAPE CRITIQUE : Cr√©er .nojekyll AVANT le rendu
      - name: Create .nojekyll BEFORE rendering
        run: |
          echo "üõë Cr√©ation de .nojekyll AVANT le rendu..."
          
          # Cr√©er le dossier docs/ d'abord
          mkdir -p docs
          
          # Cr√©er .nojekyll avec un contenu EXPLICITE
          echo "# DO NOT USE JEKYLL - This is a Quarto static site
# GitHub Pages should NOT process this with Jekyll
# This file disables Jekyll processing completely" > docs/.nojekyll
          
          # Cr√©er aussi √† la racine pour √™tre s√ªr
          echo "# NO JEKYLL" > .nojekyll
          
          echo "‚úÖ .nojekyll cr√©√©"

      - name: Render website with Jekyll disabled
        run: |
          echo "üöÄ Rendu avec Jekyll d√©sactiv√©..."
          
          # Variable d'environnement pour d√©sactiver Jekyll
          export JEKYLL_ENV=production
          
          # Rendu Quarto
          quarto render
          
          echo "‚úÖ Rendu termin√©"

      # √âTAPE CRITIQUE : POST-traitement AGGRESSIF
      - name: Aggressive Jekyll cleanup AFTER render
        run: |
          echo "üõë NETTOYAGE AGGRESSIF APR√àS rendu..."
          
          # 1. S'assurer que docs/ existe
          mkdir -p docs
          
          # 2. FORCER .nojekyll (au cas o√π Quarto l'aurait √©cras√©)
          echo "NO JEKYLL - Static HTML site" > docs/.nojekyll
          chmod 644 docs/.nojekyll
          
          # 3. Supprimer TOUS les fichiers/dossiers qui pourraient d√©clencher Jekyll
          echo "Suppression des fichiers probl√©matiques..."
          
          # Supprimer tous les fichiers SCSS dans docs/
          find docs -name "*.scss" -type f -delete 2>/dev/null || true
          find docs -name "*.sass" -type f -delete 2>/dev/null || true
          
          # Supprimer tous les dossiers commen√ßant par _
          find docs -name "_*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # Supprimer le dossier assets/css/ S'IL contient des SCSS
          if [ -d "docs/assets/css" ]; then
            # Supprimer seulement les SCSS, garder les CSS
            find docs/assets/css -name "*.scss" -delete 2>/dev/null || true
            find docs/assets/css -name "*.sass" -delete 2>/dev/null || true
            
            # Si le dossier est vide apr√®s suppression, le supprimer
            if [ -z "$(ls -A docs/assets/css 2>/dev/null)" ]; then
              rm -rf docs/assets/css
            fi
          fi
          
          # 4. Renommer index.qmd.html si n√©cessaire
          if [ -f "docs/index.qmd.html" ]; then
            mv docs/index.qmd.html docs/index.html
            echo "‚úÖ index.qmd.html ‚Üí index.html"
          fi
          
          # 5. V√©rifier qu'il n'y a pas de assets/css/style.scss
          if [ -f "docs/assets/css/style.scss" ]; then
            echo "‚ùå DANGER: style.scss toujours pr√©sent - suppression FORC√âE"
            rm -f docs/assets/css/style.scss
            
            # Cr√©er un fichier CSS vide √† la place
            mkdir -p docs/assets/css
            echo "/* Empty CSS file - Jekyll disabled */" > docs/assets/css/style.css
          fi
          
          # 6. Liste des fichiers FINALE pour v√©rification
          echo "üìÅ CONTENU FINAL de docs/:"
          ls -la docs/
          echo ""
          echo "üîç Recherche de fichiers SCSS restants:"
          find docs -name "*.scss" -o -name "*.sass" | head -20
          echo ""
          echo "üîç V√©rification .nojekyll:"
          ls -la docs/.nojekyll
          cat docs/.nojekyll

      # √âTAPE CRITIQUE : V√©rification finale
      - name: Final verification - NO Jekyll files
        run: |
          echo "üîç V√âRIFICATION FINALE - AUCUN fichier Jekyll..."
          
          # Compter les fichiers probl√©matiques
          scss_count=$(find docs -name "*.scss" -o -name "*.sass" 2>/dev/null | wc -l)
          jekyll_dirs=$(find docs -name "_*" -type d 2>/dev/null | wc -l)
          
          if [ "$scss_count" -eq 0 ] && [ "$jekyll_dirs" -eq 0 ]; then
            echo "‚úÖ SUCC√àS: Aucun fichier SCSS/SASS et aucun dossier _*"
          else
            echo "‚ùå √âCHEC: Fichiers Jekyll d√©tect√©s!"
            echo "   SCSS/SASS files: $scss_count"
            echo "   Jekyll dirs: $jekyll_dirs"
            echo "   List:"
            find docs -name "*.scss" -o -name "*.sass" -o -name "_*" -type d 2>/dev/null
            exit 1  # √âchec d√©lib√©r√©
          fi
          
          # V√©rifier que .nojekyll est pr√©sent
          if [ ! -f "docs/.nojekyll" ]; then
            echo "‚ùå CRITIQUE: .nojekyll manquant!"
            exit 1
          fi
          
          echo "üéØ PR√äT pour d√©ploiement sans Jekyll!"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'